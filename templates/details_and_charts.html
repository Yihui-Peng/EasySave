{% extends "base.html" %}

{% block title %}Details and Charts{% endblock %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}
{% block content %}
<script>
    function updateSubcategories() {
        const level1 = document.getElementById("category_level_1").value;
        const level2 = document.getElementById("category_level_2");
        level2.innerHTML = "";
        level2.disabled = false;

        let options = [];

        if (level1 === "All Spending") {
            options = [{ display: "All", value: "All" }];
        } else if (level1 === "Disposable_income") {
            options = [
                { display: "Living Expense", value: "living_expense" },
                { display: "Allowance", value: "allowance" },
                { display: "Income", value: "income" }
            ];
        } else if (level1 === "Necessities") {
            options = [
                { display: "Tuition", value: "tuition" },
                { display: "Housing", value: "housing" },
                { display: "Food", value: "food" },
                { display: "Transportation", value: "transportation" }
            ];
        } else if (level1 === "Flexible_spending") {
            options = [
                { display: "Study Materials", value: "study_materials" },
                { display: "Entertainment", value: "entertainment" },
                { display: "Technology", value: "technology" },
                { display: "Personal Care", value: "personal_care" }
            ];
        } else if (level1 === "Others") {
            options = [
                { display: "Apparel", value: "apparel" },
                { display: "Travel", value: "travel" },
                { display: "Others", value: "others" }
            ];
        } else {
            level2.disabled = true;
            return;
        }

        options.forEach(option => {
            const opt = document.createElement("option");
            opt.value = option.value;
            opt.textContent = option.display;
            // 保持二级分类的选择
            if (option.value === "{{ selected_category_level_2 }}") {
                opt.selected = true;
            }
            level2.appendChild(opt);
        });
    }

    // 页面加载时调用函数以更新二级分类并设置选中项
    window.onload = function() {
        updateSubcategories();
    };
</script>

<div class="container">
    <!-- Start of the form -->
    <form method="POST">
        <div class="category-selection">
            <label for="category_level_1">Category-Level-1:</label>
            <select id="category_level_1" name="category_level_1" onchange="updateSubcategories()">
                <option value="All Spending" {% if selected_category_level_1 == 'All Spending' %}selected{% endif %}>All Spending</option>
                <option value="Necessities" {% if selected_category_level_1 == 'Necessities' %}selected{% endif %}>Necessities</option>
                <option value="Flexible_spending" {% if selected_category_level_1 == 'Flexible_spending' %}selected{% endif %}>Flexible Spending</option>
                <option value="Others" {% if selected_category_level_1 == 'Others' %}selected{% endif %}>Others</option>
                <option value="Disposable_income" {% if selected_category_level_1 == 'Disposable_income' %}selected{% endif %}>Disposable Income</option>
            </select>
    
            <label for="category_level_2">Subcategory-Level-2:</label>
            <select id="category_level_2" name="category_level_2">
                <!-- 选项由 JavaScript 动态生成 -->
            </select>
        </div>
    
        <button type="submit">Filter</button>
    </form>
    <!-- End of the form -->

    <div class="block block-1 spending-summary">
        <h3>Spending Records</h3>
        <div class="spending-records" id="spending-records" style="overflow-y: auto; max-height: 400px;">
            {% if records %}
                {% for record in records %}
                    <div class="record">
                        <p>Amount: {{ record.amount }}, Category: {{ record.category }}, Date: {{ record.date.strftime('%Y-%m-%d') }}</p>
                        {% if record.note %}
                            <button onclick="showNote('{{ record.note }}')" class="btn btn-secondary">Show Note</button>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>No records to display.</p>
            {% endif %}
        </div>
    </div>

    <div class="block block-2">
        <h3>Spending Distribution Chart</h3>
        <canvas id="distributionChart" width="400" height="300"></canvas>
    </div>

    <div class="block block-3">
        <h3>Monthly Spending Chart</h3>
        <canvas id="monthlyChart" width="400" height="300"></canvas>
    </div>

    <script>
        function showNote(note) {
            alert(note);
        }
    </script>

    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript">
        
        const distributionData = JSON.parse('{{ distribution_data_json | safe }}');
        const monthlyData = JSON.parse('{{ monthly_data_json | safe }}');

        // Spending Distribution Chart
        const ctx1 = document.getElementById('distributionChart').getContext('2d');
        const distributionChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: distributionData.labels,
                datasets: [{
                    label: 'Number of Users',
                    data: distributionData.values,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                }]
            },
            options: {
                scales: {
                    x: { title: { display: true, text: 'Spending Amount Range' } },
                    y: { title: { display: true, text: 'Number of Users' } }
                }
            }
        });

        // Monthly Spending Chart
        const ctx2 = document.getElementById('monthlyChart').getContext('2d');
        const monthlyChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: monthlyData.labels,
                datasets: [{
                    label: 'Total Spending',
                    data: monthlyData.values,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                }]
            },
            options: {
                scales: {
                    x: { title: { display: true, text: 'Month' } },
                    y: { title: { display: true, text: 'Spending Amount' } }
                }
            }
        });
    </script>
</div>
{% endblock %}