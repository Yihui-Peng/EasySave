{% extends "base.html" %}

{% block title %}Home{% endblock %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}
{% block content %}
    <h2>Welcome, {{ user.nickname }}</h2>
    <p>This is the home page.</p>

    <div class="spending-summary">
       
        <div class="previous-spending">
            <h2>Previous Records</h2>
            {% if prev_spending %}
            <p id="Spending_name">{{ prev_spending.category + " " + prev_spending.date.strftime('%Y-%m-%d') }}</p>
            <p id="Spending_amount"> â‚¬{{ prev_spending.amount }}</p>
            <p id="Note">Note: {{ prev_spending.note }}</p>
            {% endif %}
        </div>
     

       
        <div class="saving-goal">
            <h2>Saving Goal</h2>
            {% if savingGoal %}
            <canvas id="myPieChart" width="200" height="200"></canvas>
            {% endif %}
        </div>
        
        
        <div class="remaining-today">
            <h2>Today's Remaining</h2>
            <p id="todayRemaining">666</p>
        </div>
    </div>
    
    <div class="container">
        <div class="advice-section">
            <h2>Advices</h2>
            {% if insights %}
                <ul>
                    {% for insight in insights %}
                        <li>{{ insight }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No insights available at the moment.</p>
            {% endif %}
        </div>
        <div class="new-records">
            <h2>New Records</h2>
            <form action="" method="post">
                <!-- Form inputs for adding new spending -->
            </form>
        </div>
    </div>

    {% if savingGoal %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var ctx = document.getElementById('myPieChart').getContext('2d');
            var used = parseFloat('{{ savingGoal.progress_amount | default(0) }}');
            var total = parseFloat('{{ savingGoal.amount | default(1) }}');
            var remaining = total - used;

            var myPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Used', 'Remaining'],
                    datasets: [{
                        data: [used, remaining],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)', // Red
                            'rgba(54, 162, 235, 0.2)'  // Blue
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        datalabels: {
                            formatter: (value, context) => {
                                let sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value / sum * 100).toFixed(2) + "%";
                                return percentage;
                            },
                            color: '#fff',
                        }
                    }
                }
            });
        });
    </script>
    {% endif %}
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
