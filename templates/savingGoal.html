{% extends "base.html" %}

{% block title %}Saving Goal{% endblock %}

{% block content %}
<h1>Saving Goal</h1>

<!-- Goal form -->
<div class="goal-form">
    <form method="POST" action="/savingGoal">
        <!-- Goal Amount -->
        <label for="amount">Amount:</label>
        <input type="number" id="amount" name="amount" placeholder="Enter amount" required><br>

        <!-- Start Date -->
        <div class="form-group" style="margin-bottom: 20px;">
            <label class="form-label" for="start-date">Start Date</label>
            <input type="date" id="start-date" name="start-date" class="form-control" lang="en" required>
        </div>

        <!-- End Date -->
        <div class="form-group" style="margin-bottom: 20px;">
            <label class="form-label" for="end-date">End Date</label>
            <input type="date" id="end-date" name="end-date" class="form-control" lang="en" required>
        </div>

        <!-- Progress -->
        <label for="progress">Progress:</label>
        <select id="progress" name="progress" required>
        <option value="">Select Progress</option>
        <option value="ongoing">Ongoing</option>
        <option value="finished">Finished</option>
        </select><br>


        <!-- Progress Amount (Visible only when "Ongoing") -->
    <label for="progress-amount" id="progress-amount-label" style="display:none;">Progress Amount:</label>
    <input type="number" id="progress-amount" name="progress_amount" style="display:none;" placeholder="Progress amount"><br>


        <button type="submit">Add Goal</button>
    </form>
</div>

<!-- Goal list -->
<div id="goal-list">
    <h2>Goals</h2>
    <form method="POST" action="/delete_selected_goals" id="delete-goals-form">
        <ul id="goal-list-items">
            {% for goal in goals %}
            <li>
                <input type="checkbox" name="goal_ids" value="{{ goal.saving_goal_id }}">
                Goal: ${{ goal.amount }} | Progress: {{ goal.progress }} | Progress Amount: {{ goal.progress_amount }}
            </li>
            {% else %}
            <li>No goals added yet.</li>
            {% endfor %}
        </ul>

        <!-- Delete Selected Goals Button -->
        <button type="submit" id="delete-selected-goals" {% if goals|length == 0 %}disabled{% endif %}>Delete Selected Goals</button>
    </form>
</div>

<script>
        // Optional JavaScript to enable/disable the "Delete" button based on selected checkboxes
    const deleteButton = document.getElementById('delete-selected-goals');
    const checkboxes = document.querySelectorAll('input[name="goal_ids"]');

    // Enable or disable delete button based on checkbox selection
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            const selected = Array.from(checkboxes).some(chk => chk.checked);
            deleteButton.disabled = !selected;  // Enable if at least one checkbox is checked
        });
    });


        const goals = [];
        let selectedGoalIndex = -1;

        // Toggle progress amount visibility based on progress selection
        document.getElementById('progress').addEventListener('change', function() {
    const progress = this.value;
    const progressAmountLabel = document.getElementById('progress-amount-label');
    const progressAmount = document.getElementById('progress-amount');
    const amount = parseFloat(document.getElementById('amount').value);

    if (progress === "ongoing") {
        progressAmountLabel.style.display = "inline";
        progressAmount.style.display = "inline";

        // Allow user to input progress amount
        progressAmount.value = "";  // Clear any existing value so user can input progress
    } else if (progress === "finished") {
        progressAmountLabel.style.display = "none";
        progressAmount.style.display = "none";

        // Set progress amount to be the same as the goal amount
        progressAmount.value = amount;
    } else {
        // If no valid progress is selected, hide the progress amount input
        progressAmountLabel.style.display = "none";
        progressAmount.style.display = "none";
    }
});



        // Add a new goal to the list
    function addGoal() {
        const amount = parseFloat(document.getElementById('amount').value);

        // Get start and end dates from the date inputs
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        const progress = document.getElementById('progress').value;
        const progressAmount = parseFloat(document.getElementById('progress-amount').value);

        // Validate input values
        if (!amount || !startDate || !endDate) {
            alert("Please fill in all fields.");
            return;
        }

        const startDateObj = new Date(startDate);
        const endDateObj = new Date(endDate);

        // Ensure valid dates
        if (isNaN(startDateObj.getTime()) || isNaN(endDateObj.getTime())) {
            alert("Invalid date format. Please check the selected dates.");
            return;
        }

        // Check if the start date is before the end date
        if (startDateObj > endDateObj) {
            alert("Start date cannot be later than end date.");
            return;
        }

        if (progress === "ongoing" && progressAmount >= amount) {
            alert("Progress amount must be less than the goal amount.");
            return;
        }

        const goal = {
            amount,
            start_date: startDate,
            end_date: endDate,
            progress,
            progress_amount
        };

            goals.push(goal);
            updateGoalList();
            clearFields();
        }

        // Update the goal list display
        function updateGoalList() {
            const list = document.getElementById('goal-list-items');
            list.innerHTML = "";
            goals.forEach((goal, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('goal-item');

                // Add a checkbox to each goal
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'goal-checkbox-' + index;
                checkbox.onclick = function () { toggleGoalSelection(index, checkbox); };

                // Display goal details in list item
                const goalText = document.createElement('span');
                goalText.textContent = `Goal: $${goal.amount} | Progress: ${goal.progress} | Progress Amount: ${goal.progress_amount}`;

                listItem.appendChild(checkbox);
                listItem.appendChild(goalText);
                list.appendChild(listItem);
            });
        }

        // Toggle selection of a goal
        function toggleGoalSelection(index, checkbox) {
            if (checkbox.checked) {
            selectedGoalIndex = index;
        } else {
            selectedGoalIndex = -1;
            document.getElementById('goal-details').style.display = 'none';
    }
}

        // Show selected goal details
        function showGoalDetails() {
            if (selectedGoalIndex === -1) {
                alert("Please select a goal first.");
                return;
            }

            const goal = goals[selectedGoalIndex];
            const goalDetails = document.getElementById('goal-detail-info');
            goalDetails.innerHTML = `
                <strong>Amount:</strong> $${goal.amount}<br>
                <strong>Start Date:</strong> ${goal.start_date}<br>
                <strong>End Date:</strong> ${goal.end_date}<br>
                <strong>Progress:</strong> ${goal.progress}<br>
                <strong>Progress Amount:</strong> ${goal.progress_amount}<br>
            `;
            document.getElementById('goal-details').style.display = 'block';
        }

         // Delete selected goal
        function deleteSelectedGoals() {
            if (selectedGoalIndex === -1) {
                alert("Please select a goal to delete.");
                return;
            }

            goals.splice(selectedGoalIndex, 1);
            updateGoalList();
            document.getElementById('goal-details').style.display = 'none';
            selectedGoalIndex = -1;
        }

        // Clear the form fields
        function clearFields() {
    document.getElementById('amount').value = '';
    document.getElementById('start-date').value = '';
    document.getElementById('end-date').value = '';
    document.getElementById('progress').value = '';
    document.getElementById('progress-amount').value = '';
}
</script>
{% endblock %}
